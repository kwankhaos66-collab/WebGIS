<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ç‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;500;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script> 
    
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-ajax/2.1.0/leaflet.ajax.min.js"></script>
    
    <style>
        /* ... (CSS styles remains unchanged) ... */
        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: 'Prompt', sans-serif;
            background: linear-gradient(135deg, #fdfaf5, #ece3d6);
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h3 {
            margin: 15px 0 10px;
            color: #5a4723;
            font-size: 1.5rem;
            font-weight: 600;
            letter-spacing: 1px;
        }

        #mapid {
            width: 95%;
            height: calc(100vh - 70px);
            border-radius: 15px;
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.15);
            overflow: hidden;
        }

        @media (max-width: 768px) {
            h3 {
                font-size: 1.2rem;
                margin-top: 10px;
            }

            #mapid {
                width: 95%;
                height: calc(100vh - 60px);
            }
        }
    </style>
</head>
<body>
    <h3>üó∫Ô∏è ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</h3>
    <div id="mapid"></div>

    <script>
        
        // ‚úÖ Base Layers
        const baseLayers = {
            "üó∫Ô∏è ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ (OSM)": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }),

            "üõ∞Ô∏è ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏î‡∏≤‡∏ß‡πÄ‡∏ó‡∏µ‡∏¢‡∏° (Esri)": L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri'
            }),

            "üèîÔ∏è ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏†‡∏π‡∏°‡∏¥‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏® (Topo)": L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                attribution: 'Map data ¬© OpenTopoMap contributors'
            })
        };

        // üÜï Overlay Layers (WMS)
        const overlayLayers = {
            "üó∫Ô∏è Map WMS (plk_buildings)": L.tileLayer.wms('http://localhost:8085/geoserver/geo42/wms', { 
                layers: 'geo42:plk_buildings', // ‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏•‡∏ö‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö Workspace:LayerName
                format: 'image/png', 
                opacity: 0.5, 
                transparent: true, 
                tiled: 'true',
                attribution: 'WMS Data'
            })
        };

        // ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
        const map = L.map('mapid', {
            center: [15.5, 100.3],
            zoom: 7,
            layers: [baseLayers["üó∫Ô∏è ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ (OSM)"]]
        });

        // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà (‡∏ó‡∏±‡πâ‡∏á Base ‡πÅ‡∏•‡∏∞ Overlay)
        L.control.layers(baseLayers, overlayLayers).addTo(map);

        // üìå ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö marker
        let markers = [];
        let geojsonLayer = null; // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö GeoJSON Layer

        // üÜï ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÉ‡∏ô Parent Frame
        function updateResultCount(count) {
            if (window.parent && window.parent.document.getElementById('iframeMenu')) {
                window.parent.document.getElementById('iframeMenu').contentWindow.postMessage({ 
                    type: 'updateCount', 
                    count: count 
                }, '*');
            }
        }
        
        // üÜï ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô: ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• GeoJSON ‡∏à‡∏≤‡∏Å PHP (PostGIS)
        async function fetchGeoJSON(keyword = '') {
            // ‚ö†Ô∏è ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏°‡∏≤‡πÉ‡∏ä‡πâ URL ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á: agi65.php
            let url = '';
            if (keyword.trim() === '') {
                url = `agi65.php?type=initial`;
                updateResultCount('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î...');
            } else {
                const encodedKeyword = encodeURIComponent(keyword);
                url = `agi65.php?type=keyword&value=${encodedKeyword}`; 
                updateResultCount(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ "${keyword}"...`);
            }
            
            try {
                const response = await fetch(url);
                const data = await response.json();
                return data; 
            } catch (error) {
                console.error("Error fetching data:", error);
                updateResultCount('‚ùå Error ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö agi65.php)');
                return { type: 'FeatureCollection', features: [] };
            }
        }


        // üîÑ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï marker ‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà (‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á)
        async function updateMap(keyword = '') {
            // 1. ‡∏•‡∏ö layer ‡πÄ‡∏Å‡πà‡∏≤‡∏≠‡∏≠‡∏Å
            if (geojsonLayer) {
                map.removeLayer(geojsonLayer);
            }
            
            // 2. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå
            const liveGeojson = await fetchGeoJSON(keyword);

            // 3. ‡∏™‡∏£‡πâ‡∏≤‡∏á GeoJSON Layer ‡πÉ‡∏´‡∏°‡πà
            // ‡πÉ‡∏ä‡πâ L.geoJSON ‡πÅ‡∏ó‡∏ô L.GeoJSON.AJAX ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏£‡∏≤‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£ fetch ‡πÄ‡∏≠‡∏á‡∏î‡πâ‡∏ß‡∏¢ fetchGeoJSON
            geojsonLayer = L.geoJSON(liveGeojson, {
                pointToLayer: function (feature, latlng) {
                    // ‡πÉ‡∏ä‡πâ Marker Icon ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
                    return L.marker(latlng);
                },
                onEachFeature: function (feature, layer) {
                    const p = feature.properties;
                    if (p) {
                        // ‚ÑπÔ∏è ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ï‡∏±‡∏ß‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡πá‡∏Å‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏ô PHP
                        const popupContent = `
                            <b>${p.s_name} (${p.s_id})</b><br>
                            ‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£: ${p.curriculum}<br>
                            ‡∏Ñ‡∏ì‡∏∞: ${p.faculty}<br>
                            ‡∏à‡∏ö‡∏à‡∏≤‡∏Å: ${p.graduated_school}<br>
                            ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î: ${p.province}
                        `;
                        layer.bindPopup(popupContent);
                    }
                }
            }).addTo(map);

            // 4. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
            const featureCount = liveGeojson.features ? liveGeojson.features.length : 0;
            updateResultCount(featureCount);
            
            // 5. ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà (Auto-zoom)
            if (featureCount > 0) {
                map.fitBounds(geojsonLayer.getBounds(), { padding: [20, 20] });
            } else {
                // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå ‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ã‡∏π‡∏°‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢ (‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô)
                map.setView([15.5, 100.3], 7);
            }
        }

        // üì• ‡∏£‡∏±‡∏ö keyword ‡∏à‡∏≤‡∏Å iframe (‡πÄ‡∏ä‡πà‡∏ô‡∏à‡∏≤‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤)
        window.addEventListener("message", (e) => {
            const keyword = e.data.keyword || '';
            updateMap(keyword);
        });

        // üîÉ ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
        updateMap();
    </script>
</body>
</html>