<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üèûÔ∏è ‡∏à‡∏∏‡∏î‡πÄ‡∏î‡∏¥‡∏ô‡∏õ‡πà‡∏≤‡πÅ‡∏•‡∏∞‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥‡πÉ‡∏ô‡πÑ‡∏ó‡∏¢ (Client-Side Search)</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏µ‡∏´‡∏•‡∏±‡∏Å - ‡πÇ‡∏ó‡∏ô‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•/‡πÄ‡∏ö‡∏à/‡πÄ‡∏≠‡∏¥‡∏£‡πå‡∏ò‡πÇ‡∏ó‡∏ô */
        :root {
            --color-primary: #633f17; 
            --color-secondary: #a89c82; 
            --color-accent: #b8860b; 
            --color-bg: #f5f0e9; 
            --color-text: #685e4e; 
            --color-border: #d4c1a0; 
            --color-white: #ffffff;
            --color-brown-text: #4e4437;
        }
        
        body { 
            font-family: 'Prompt', sans-serif; 
            text-align: center; 
            background: linear-gradient(135deg, var(--color-bg), #e6e0d9); 
            color: var(--color-text); 
            padding-bottom: 50px; 
            padding-top: 80px; 
            margin: 0;
            line-height: 1.6;
        }
        h1 { 
            color: var(--color-primary); 
            margin-top: 25px; 
            margin-bottom: 10px;
            font-weight: 700;
            font-size: 2.2em;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.05);
        }
        .note { 
            color: #6a6a6a; 
            font-size: 1.1em; 
            margin-bottom: 25px; 
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }
        #map { 
            height: 75vh; 
            width: 92%; 
            margin: 0 auto; 
            border: 2px solid var(--color-border); 
            border-radius: 15px; 
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15); 
            z-index: 1; 
            transition: all 0.3s ease;
        }
        #map:hover {
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }
        
        /* ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á */
        .result-text { 
            font-weight: 600; 
            color: var(--color-primary); 
            font-size: 1.15em; 
            margin-top: 8px; 
        } 

        /* ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ô Popup */
        .leaflet-popup-content button { 
            background-color: var(--color-secondary); 
            color: var(--color-primary); 
            border: 1px solid var(--color-primary);
            padding: 10px 15px; 
            font-size: 14px; 
            margin: 10px 5px 5px 5px; 
            cursor: pointer; 
            border-radius: 8px; 
            transition: background-color 0.3s ease, transform 0.2s ease; 
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15);
        }
        .leaflet-popup-content button:hover { 
            background-color: var(--color-primary); 
            color: var(--color-white); 
            transform: translateY(-2px);
        }
        .leaflet-popup-content h3 {
            color: var(--color-primary);
            margin: 5px 0 10px 0;
            padding-bottom: 5px;
            border-bottom: 2px solid var(--color-border);
            font-size: 1.4em;
            font-weight: 600;
        }
        .leaflet-popup-content h4 { 
            margin: 12px 0 6px 0; 
            color: var(--color-text); 
            font-size: 1.1em;
            font-weight: 600;
        }
        .leaflet-popup-content .invite-text { 
            font-style: italic; 
            color: var(--color-primary); 
            font-size: 1em;
            padding: 8px 12px;
            border-left: 4px solid var(--color-secondary);
            background-color: #f7f3ed; 
            border-radius: 6px;
            margin-top: 10px;
        }

        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Input ‡πÉ‡∏ô Popup (Search/Insert) */
        .leaflet-popup-content input[type="text"],
        .leaflet-popup-content input[type="number"] {
            padding: 5px 8px;
            border-radius: 4px;
            border: 1px solid var(--color-border);
            width: 90%;
            margin-bottom: 8px;
            box-sizing: border-box;
            font-family: 'Prompt', sans-serif;
            color: var(--color-primary);
            text-align: center; 
        }
        .leaflet-popup-content label {
            display: inline-block;
            width: 40%;
            text-align: right;
            margin-right: 5px;
        }

        /* ‡πÅ‡∏ú‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á (Control Panel) */
        .filter-panel { 
            width: 92%; 
            margin: 30px auto 20px auto; 
            padding: 25px; 
            background-color: var(--color-white); 
            border-radius: 15px; 
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); 
            text-align: left; 
            display: flex; 
            gap: 25px; 
            justify-content: center; 
            flex-wrap: wrap; 
            border: 1px solid var(--color-border);
        }
        .filter-group { flex: 1; min-width: 180px; position: relative; }
        .filter-group label { font-weight: 600; color: var(--color-primary); display: block; margin-bottom: 8px; font-size: 1.1em; }
        .filter-group select {
            padding: 10px 15px; padding-right: 35px; border-radius: 8px; border: 2px solid var(--color-border); 
            background-color: var(--color-white); min-width: 100%; cursor: pointer; transition: all 0.3s ease;
            -webkit-appearance: none; -moz-appearance: none; appearance: none; background-repeat: no-repeat;
            background-position: right 12px center; background-size: 10px; color: var(--color-brown-text);
        }
        .filter-group select:hover { border-color: var(--color-secondary); box-shadow: 0 0 0 1px var(--color-secondary); }
        .filter-group select:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(99, 63, 23, 0.2); }

        /* Custom Arrow */
        .filter-group::after { content: '‚ñº'; position: absolute; top: 40px; right: 15px; font-size: 10px; color: var(--color-primary); pointer-events: none; z-index: 10; transition: transform 0.2s; }
        
        /* ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Legend */
        .legend { line-height: 25px; color: var(--color-brown-text); background: rgba(255, 255, 255, 0.95); padding: 15px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border: 1px solid var(--color-border); }
        .legend h4 { color: var(--color-primary); margin-top: 0; margin-bottom: 10px; font-size: 1.15em; font-weight: 600; }
        .legend i { width: 20px; height: 20px; float: left; margin-right: 10px; opacity: 0.95; border-radius: 50%; border: 1px solid rgba(0,0,0,0.1); }

        /* ‡∏Å‡∏£‡∏≤‡∏ü‡∏¥‡∏Å‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡πÉ‡∏ô Popup */
        .elevation-chart { margin-top: 15px; padding-top: 10px; border-top: 1px dashed #d8d8d8; text-align: left; }
        .elevation-chart p { margin-bottom: 5px; color: #777; font-size: 0.9em; }
        .elevation-bar { width: 100%; height: 18px; background-color: #f7f3ed; border-radius: 9px; margin-top: 5px; overflow: hidden; position: relative; border: 1px solid var(--color-border); }
        .elevation-fill { 
            height: 100%; background: linear-gradient(90deg, #d4c1a0, var(--color-primary)); 
            border-radius: 9px; transition: width 0.7s ease-out; position: absolute; top: 0; left: 0; z-index: 2; 
            display: flex; align-items: center; justify-content: flex-end; padding-right: 5px; font-size: 0.75em;
            color: var(--color-white); font-weight: 600; text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }
        
        /* üß≠ ‡πÅ‡∏ñ‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô (Navbar) */
        nav { position: fixed; top: 0; left: 0; width: 100%; display: flex; justify-content: center; gap: 30px; padding: 15px 0; background: rgba(66, 48, 14, 0.863); backdrop-filter: blur(8px); z-index: 999; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        nav a { color: #fff; text-decoration: none; font-size: 15px; padding: 10px 18px; border-radius: 25px; transition: 0.3s ease; font-weight: 500; }
        nav a:hover { background: #d4c1a0; color: #3e2f1f; }
        @media (max-width: 768px) { nav { flex-wrap: wrap; gap: 10px; padding: 10px 5px; } nav a { font-size: 14px; padding: 8px 14px; } }
    </style>
</head>
<body>
    
 <nav>
    <a href="me000.html">üè† HOME</a>
    <a href="me00.html">üôã‚Äç‚ôÄÔ∏è ALL ME</a>
    <a href="me01.html">üåç WHAT IS GEOGRAPHY?</a>
    <a href="me02.html">üß† CHANGING THINKING</a>
    <a href="webmap00.html">üó∫Ô∏è AGI STUDENT</a>
    <a href="trip.html">üèûÔ∏è HIKING MAPS</a>
    <a href="miniprojcet.html">üõ∞Ô∏è ALL MAPS</a>
    </nav>
    
    <h1>üå≤ ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∏‡∏î‡πÄ‡∏î‡∏¥‡∏ô‡∏õ‡πà‡∏≤‡πÅ‡∏•‡∏∞‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥‡πÉ‡∏ô‡πÑ‡∏ó‡∏¢ üèûÔ∏è</h1>
    <p class="note">Marker ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å | **‡∏î‡∏±‡∏ö‡πÄ‡∏ö‡∏¥‡∏•‡∏Ñ‡∏•‡∏¥‡∏Å‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà** ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡πÉ‡∏´‡∏°‡πà | **‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏î‡∏µ‡∏¢‡∏ß** ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á</p>
    
    <div class="filter-panel">
        <div class="filter-group">
            <label for="province-filter">üìç ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î:</label>
            <select id="province-filter" onchange="filterMap()">
                <option value="all">-- ‡∏ó‡∏∏‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î --</option>
            </select>
            <div class="custom-arrow"></div> 
        </div>
        
        <div class="filter-group">
            <label for="difficulty-filter">üí™ ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å:</label>
            <select id="difficulty-filter" onchange="filterMap()">
                <option value="all">-- ‡∏ó‡∏∏‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö --</option>
                <option value="‡∏á‡πà‡∏≤‡∏¢">‡∏á‡πà‡∏≤‡∏¢ (Easy)</option>
                <option value="‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á">‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á (Moderate)</option>
                <option value="‡∏¢‡∏≤‡∏Å">‡∏¢‡∏≤‡∏Å (Hard)</option>
                <option value="‡∏ó‡πâ‡∏≤‡∏ó‡∏≤‡∏¢">‡∏ó‡πâ‡∏≤‡∏ó‡∏≤‡∏¢ (Challenging)</option>
            </select>
            <div class="custom-arrow"></div> 
        </div>

        <div class="filter-group">
            <label for="type-filter">üèûÔ∏è ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:</label>
            <select id="type-filter" onchange="filterMap()">
                <option value="all">-- ‡∏ó‡∏∏‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó --</option>
                <option value="‡∏†‡∏π‡πÄ‡∏Ç‡∏≤/‡∏¢‡∏≠‡∏î‡πÄ‡∏Ç‡∏≤">‡∏†‡∏π‡πÄ‡∏Ç‡∏≤/‡∏¢‡∏≠‡∏î‡πÄ‡∏Ç‡∏≤</option>
                <option value="‡∏ô‡πâ‡∏≥‡∏ï‡∏Å">‡∏ô‡πâ‡∏≥‡∏ï‡∏Å</option>
                <option value="‡∏≠‡∏∏‡∏ó‡∏¢‡∏≤‡∏ô‡∏Ø/‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏≠‡∏∏‡∏ó‡∏¢‡∏≤‡∏ô‡∏Ø/‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
            </select>
            <div class="custom-arrow"></div> 
        </div>
    </div>
    
    <div id="map"></div>

<script>
        // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î URL ‡∏Ç‡∏≠‡∏á‡πÑ‡∏ü‡∏•‡πå GeoJSON ‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å
        const GEOJSON_FILE_URL = 'hiking.geojson';
        // **[‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç]** ‡∏Å‡∏≥‡∏´‡∏ô‡∏î URL ‡∏Ç‡∏≠‡∏á‡πÑ‡∏ü‡∏•‡πå PHP ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Insert
        const INSERT_API_URL = 'insert_hiking.php';
        
        let hikingSpotsGeoJSON = null; 
        
        // [DB Interaction] ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Search/Insert
        let searchResultLayer = null; 
        let insertLayer = null;      
        let marker_arr = [];          

        // ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏á‡∏ó‡∏µ‡πà
        const MAX_ELEVATION_M = 2565; 
        const START_LAT = 13.7563;
        const START_LON = 100.5018; 
        const startPoint = [START_LAT, START_LON]; 

        // ‡∏™‡∏µ Marker ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å ‡πÅ‡∏•‡∏∞ 'brown' ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
        const difficultyColors = { '‡∏á‡πà‡∏≤‡∏¢': 'green', '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á': 'blue', '‡∏¢‡∏≤‡∏Å': 'orange', '‡∏ó‡πâ‡∏≤‡∏ó‡∏≤‡∏¢': 'red', 'N/A': 'grey', 'brown': 'brown' };

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á Icon (Marker)
        function createColoredIcon(color) {
            return L.icon({
                iconUrl: `https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${color}.png`,
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
            });
        }

        var map = L.map('map').setView([15.87, 100.99], 6);
        var geoJsonLayer; 

        // ----------------------------------------------------
        // [Base Layers]
        // ----------------------------------------------------
        var baseLayers = {
            "üó∫Ô∏è ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ (OSM)": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' }),
            "üõ∞Ô∏è ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏î‡∏≤‡∏ß‡πÄ‡∏ó‡∏µ‡∏¢‡∏° (Esri)": L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community' }),
            "üèîÔ∏è ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏†‡∏π‡∏°‡∏¥‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏® (Topo)": L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', { attribution: 'Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: &copy; <a href="https://opentopomap.org">OpenTopoMap</a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA</a>)' })
        };
        
        baseLayers["üó∫Ô∏è ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ (OSM)"].addTo(map);
        L.control.layers(baseLayers).addTo(map);
        
        // ----------------------------------------------------
        // [Fixed Layer] ‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô Colored Marker Pin (‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•)
        // ----------------------------------------------------
        L.marker(startPoint, { 
            title: "‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô: ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø", 
            icon: createColoredIcon('brown') // ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•
        })
        .addTo(map)
        .bindPopup("<b>‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô: ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£</b>");

        // ------------------------------------------------
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ï‡∏£‡∏á (Haversine Formula)
        // ------------------------------------------------
        window.calculateDistanceHaversine = function(endLat, endLon, spotName) {
            
            const distance_meters = map.distance(startPoint, [endLat, endLon]);
            const distance_km = (distance_meters / 1000).toFixed(2);
            
            const outputId = `distance-${endLat}-${endLon}`.replace(/\./g, '_');
            const outputDiv = document.getElementById(outputId);
            
            if (outputDiv) {
                outputDiv.innerHTML = `<hr><p><strong>‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á (‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø) ‡∏ñ‡∏∂‡∏á ${spotName}:</strong></p><p class="result-text">${distance_km} ‡∏Å‡∏¥‡πÇ‡∏•‡πÄ‡∏°‡∏ï‡∏£ (‡πÄ‡∏™‡πâ‡∏ô‡∏ï‡∏£‡∏á)</p>`;
            }
        }

        // ------------------------------------------------
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡∏¥‡∏Å‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á 
        // ------------------------------------------------
        function getElevationChart(elevation_m) {
            if (elevation_m === null || isNaN(elevation_m)) {
                return '<p style="color: grey; font-size: 0.9em; margin-top: 10px;">(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö)</p>';
            }

            const elevation = parseFloat(elevation_m);
            const percent = ((elevation / MAX_ELEVATION_M) * 100);
            const displayPercent = percent.toFixed(0);
            
            return `
                <div class="elevation-chart">
                    <p style="margin: 0; font-size: 0.9em; font-weight: bold;">‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏Å‡∏±‡∏ö‡∏î‡∏≠‡∏¢‡∏≠‡∏¥‡∏ô‡∏ó‡∏ô‡∏ô‡∏ó‡πå (${MAX_ELEVATION_M} ‡∏°.)</p>
                    <div class="elevation-bar">
                        <div class="elevation-fill" style="width: ${percent}%;">${displayPercent}%</div>
                    </div>
                </div>
            `;
        }

        // ------------------------------------------------
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• GeoJSON (‡∏£‡∏ß‡∏°‡∏ï‡∏£‡∏£‡∏Å‡∏∞ Marker, Chart, ‡πÅ‡∏•‡∏∞‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì)
        // ------------------------------------------------
        function displayMapData(data) {
            if (geoJsonLayer) {
                map.removeLayer(geoJsonLayer); 
            }

            if (!data || !data.features || data.features.length === 0) {
                 console.warn("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• GeoJSON ‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤");
                 return;
            }
            
            // ‡∏•‡∏ö Error Overlay ‡πÄ‡∏Å‡πà‡∏≤‡∏≠‡∏≠‡∏Å
            if (document.getElementById('map').querySelector('.error-overlay')) {
                document.getElementById('map').querySelector('.error-overlay').remove();
            }

            geoJsonLayer = L.geoJSON(data, {
                pointToLayer: function (feature, latlng) {
                    if (!latlng || isNaN(latlng.lat) || isNaN(latlng.lng)) {
                         console.error("Marker Skipped: Invalid coordinates found for feature:", feature.properties.name);
                         return null; 
                    }
                    
                    const difficulty = feature.properties.difficulty || 'N/A';
                    const color = difficultyColors[difficulty] || 'grey';
                    
                    const marker = L.marker(latlng, { icon: createColoredIcon(color) });

                    const elevation_m = feature.properties.elevation_m;
                    const elevationChartHtml = getElevationChart(elevation_m);

                    const outputId = `distance-${latlng.lat}-${latlng.lng}`.replace(/\./g, '_');
                    const safeName = feature.properties.name.replace(/'/g, "\\'");
                    
                    const popupContent = `
                        <h3>${feature.properties.name}</h3>
                        <p><strong>‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î:</strong> ${feature.properties.province}</p>
                        <p><strong>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á:</strong> ${elevation_m !== null ? elevation_m + ' ‡∏°.' : 'N/A'}</p>
                        <p><strong>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å:</strong> ${difficulty} | <strong>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:</strong> ${feature.properties.type}</p>
                        
                        <hr style="margin: 8px 0; border-top: 1px solid #d8d8d8;">
                        <h4>üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÇ‡∏î‡∏¢‡∏¢‡πà‡∏≠:</h4>
                        <p style="font-size: 0.95em; color: #555;">${feature.properties.history || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏¢‡πà‡∏≠'}</p>
                        
                        <h4>üì¢ ‡∏Ñ‡∏≥‡πÄ‡∏ä‡∏¥‡∏ç‡∏ä‡∏ß‡∏ô:</h4>
                        <p class="invite-text">"${feature.properties.invite || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡πÄ‡∏ä‡∏¥‡∏ç‡∏ä‡∏ß‡∏ô'}"</p>

                        ${elevationChartHtml} 
                        
                        <button onclick="calculateDistanceHaversine(${latlng.lat}, ${latlng.lng}, '${safeName}')">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ï‡∏£‡∏á</button>
                        <div id="${outputId}"></div>
                    `;

                    marker.bindPopup(popupContent);
                    return marker;
                }
            }).addTo(map);
            
            if (geoJsonLayer.getLayers().length > 0) {
                 map.fitBounds(geoJsonLayer.getBounds(), { padding: [20, 20] });
            }
        }

        // ------------------------------------------------
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á
        // ------------------------------------------------
        function filterMap() {
            if (!hikingSpotsGeoJSON) return; 
            
            const selectedProvince = document.getElementById('province-filter').value;
            const selectedDifficulty = document.getElementById('difficulty-filter').value;
            const selectedType = document.getElementById('type-filter').value;
            
            const filteredFeatures = hikingSpotsGeoJSON.features.filter(feature => {
                const provinceMatch = selectedProvince === 'all' || feature.properties.province.includes(selectedProvince);
                const difficultyMatch = selectedDifficulty === 'all' || feature.properties.difficulty === selectedDifficulty;
                const typeMatch = selectedType === 'all' || feature.properties.type === selectedType;

                return provinceMatch && difficultyMatch && typeMatch;
            });

            const filteredGeoJSON = { type: 'FeatureCollection', features: filteredFeatures };
            displayMapData(filteredGeoJSON);
        }

        // ------------------------------------------------
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (‡∏£‡∏ß‡∏°‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡πÅ‡∏•‡∏∞ Legend)
        // ------------------------------------------------
        function initializeMapControls() {
            // 1. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î
            const provinces = [...new Set(hikingSpotsGeoJSON.features.map(f => f.properties.province))].sort();
            const provinceFilter = document.getElementById('province-filter');
            
            provinces.forEach(province => {
                const option = document.createElement('option');
                option.value = province;
                option.textContent = province;
                provinceFilter.appendChild(option);
            });

            // 2. ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
            displayMapData(hikingSpotsGeoJSON);
            
            // 3. ‡∏™‡∏£‡πâ‡∏≤‡∏á Legend
            const legend = L.control({position: 'bottomright'});
            legend.onAdd = function (map) {
                const div = L.DomUtil.create('div', 'info legend');
                
                // Legend ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
                const startLegend = `
                    <p style="margin: 0; font-weight: 600; color: var(--color-primary);">
                        <i style="background:brown; border: 1px solid #777;"></i> ‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø)
                    </p>
                    <hr style="margin: 8px 0; border: none; border-top: 1px dashed #ddd;">
                `;

                // Legend ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å
                const difficultyLegend = `
                    <h4>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å</h4>
                    <p style="margin: 0;">
                        ${['‡∏á‡πà‡∏≤‡∏¢', '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á', '‡∏¢‡∏≤‡∏Å', '‡∏ó‡πâ‡∏≤‡∏ó‡∏≤‡∏¢'].map(d => 
                            `<i style="background:${difficultyColors[d]}"></i> ${d}`
                        ).join('<br>')}
                    </p>
                `;
                
                div.innerHTML = startLegend + difficultyLegend;
                return div;
            };
            legend.addTo(map);
        }

        // ------------------------------------------------
        // [DB Interaction] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Search (Global Scope)
        // ------------------------------------------------
        window.sendtodb = function() { 
            // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô GeoJSON ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏Ñ‡∏•‡∏¥‡∏Å
            
            if (searchResultLayer) map.removeLayer(searchResultLayer);
            
            // ‡πÉ‡∏ä‡πâ jQuery Selector ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô DOM ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏†‡∏≤‡∏¢‡πÉ‡∏ô Popup
            const lat = parseFloat($('input#lat').val());
            const lng = parseFloat($('input#lng').val());
            const distance_km = parseFloat($('input#distance').val());
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡πà‡∏≤
            if (isNaN(lat) || isNaN(lng) || isNaN(distance_km)) {
                 alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡πà‡∏≤ Lat, Lng ‡πÅ‡∏•‡∏∞ Distance ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
                 return;
            }

            const searchCenter = L.latLng(lat, lng);
            const filteredFeatures = hikingSpotsGeoJSON.features.filter(feature => {
                const featureLat = feature.geometry.coordinates[1];
                const featureLng = feature.geometry.coordinates[0];
                const featureLatLng = L.latLng(featureLat, featureLng);

                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡πÄ‡∏™‡πâ‡∏ô‡∏ï‡∏£‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏Ñ‡∏•‡∏¥‡∏Å‡∏Å‡∏±‡∏ö Feature (‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏°‡∏ï‡∏£)
                const distance_m = map.distance(searchCenter, featureLatLng);
                const distance_km_to_feature = distance_m / 1000;
                
                // ‡∏Å‡∏£‡∏≠‡∏á Feature ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏±‡∏®‡∏°‡∏µ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î
                return distance_km_to_feature <= distance_km;
            });
            
            const searchGeoJSON = { type: 'FeatureCollection', features: filteredFeatures };

            // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
            searchResultLayer = L.geoJSON(searchGeoJSON, { 
                pointToLayer: function (feature, latlng) {
                    const distance_m = map.distance(searchCenter, latlng);
                    const distance_km_to_feature = (distance_m / 1000).toFixed(2);
                    
                    // ‡πÉ‡∏ä‡πâ Marker Pin ‡∏™‡∏µ‡∏ü‡πâ‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå Search
                    const marker = L.marker(latlng, { icon: createColoredIcon('blue') }); 
                    
                    const p = feature.properties;
                    marker.bindPopup(`
                        <h4>üîç ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á</h4>
                        <p><b>‡∏ä‡∏∑‡πà‡∏≠:</b> ${p.name}</p>
                        <p><b>‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏à‡∏∏‡∏î‡∏Ñ‡∏•‡∏¥‡∏Å:</b> <span style="color:red; font-weight:bold;">${distance_km_to_feature} km</span></p>
                        <p><b>‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î:</b> ${p.province} | <b>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å:</b> ${p.difficulty}</p>
                    `);
                    return marker;
                }
            }).addTo(map);

            // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (‡∏ß‡∏á‡∏Å‡∏•‡∏°)
            L.circle(searchCenter, { radius: distance_km * 1000, color: 'red', fillColor: '#f03', fillOpacity: 0.1, weight: 1.5 }).addTo(map);
            
            // ‡∏ã‡∏π‡∏°‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡∏Ç‡∏≠‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
            if (searchResultLayer.getLayers().length > 0) {
                 map.fitBounds(searchResultLayer.getBounds().pad(0.1), { padding: [20, 20] });
            } else {
                 alert(`‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏¥‡∏ô‡∏õ‡πà‡∏≤‡πÉ‡∏ô‡∏£‡∏±‡∏®‡∏°‡∏µ ${distance_km} km`);
            }

            // ‡∏•‡πâ‡∏≤‡∏á Marker ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≠‡∏ô‡∏Ñ‡∏•‡∏¥‡∏Å (Marker ‡∏ß‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏á‡∏Å‡∏•‡∏°)
            marker_arr.forEach(m => map.removeLayer(m));
            marker_arr = [];
        }


        // ------------------------------------------------
        // **[‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç]** ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Insert Data (Global Scope)
        // ------------------------------------------------
        window.inserttodb = function() { 
            const lat = parseFloat($('input#lat_insert').val());
            const lng = parseFloat($('input#lng_insert').val());
            const name = $('input#name_insert').val().trim();
            
            // **[‡πÄ‡∏û‡∏¥‡πà‡∏°]** ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á
            const province = $('input#province_insert').val().trim();
            const elevation_m = $('input#elevation_m_insert').val().trim(); // ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô string ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ PHP ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ NULL/‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
            if (isNaN(lat) || isNaN(lng) || name === '') {
                alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡πà‡∏≤ Lat, Lng ‡πÅ‡∏•‡∏∞ ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
                return;
            }

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á Data Object ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡πÑ‡∏õ PHP
            const dataToSend = { 
                lat: lat, 
                lng: lng, 
                name: name,
                province: province,
                elevation_m: elevation_m 
            };

            // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡πÑ‡∏ü‡∏•‡πå PHP
            $.ajax({
                url: INSERT_API_URL, 
                type: 'GET',
                data: dataToSend, // ‡πÉ‡∏ä‡πâ Data Object ‡πÉ‡∏´‡∏°‡πà
                dataType: 'json',
                success: function(response) {
                    if (response && response.error) {
                        alert("ERROR: " + response.error);
                        console.error("Insert Error Response:", response.error);
                    } else {
                        alert(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏à‡∏∏‡∏î‡πÄ‡∏î‡∏¥‡∏ô‡∏õ‡πà‡∏≤‡πÉ‡∏´‡∏°‡πà: "${name}" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!\n(‡∏û‡∏¥‡∏Å‡∏±‡∏î: ${lat.toFixed(6)}, ${lng.toFixed(6)})`);
                        // ******* ‡∏´‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà (reload) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏à‡∏∏‡∏î‡πÉ‡∏´‡∏°‡πà‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà *******
                        // window.location.reload(); 
                    }
                },
                error: function(xhr, status, error) {
                    alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠/‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: " + error);
                    console.error("AJAX Error:", status, error, xhr.responseText);
                }
            });

            // ‡∏õ‡∏¥‡∏î Popup ‡∏´‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            map.closePopup();
            marker_arr.forEach(m => map.removeLayer(m));
            marker_arr = [];
        }

        // ------------------------------------------------
        // [DB Interaction] Leaflet Listeners (Search/Insert)
        // ------------------------------------------------
        map.on("click", function (e) {
            // ‡∏•‡πâ‡∏≤‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå Search ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
            if (searchResultLayer) map.removeLayer(searchResultLayer);

            marker_arr.forEach(m => map.removeLayer(m)); marker_arr = [];
            
            var ct = "<center><h3>Search Nearby Hiking Spots</h3></center>";
            ct += "<label for='lat'>Lat:</label> <input type='number' id='lat' value='" + e.latlng.lat.toFixed(6) + "' readonly><br>";
            ct += "<label for='lng'>Lng:</label> <input type='number' id='lng' value='" + e.latlng.lng.toFixed(6) + "' readonly><br>";
            ct += "<label for='distance'>Radius (km):</label> <input type='number' id='distance' value='100' required><br><br>";
            ct += "<center><button onclick='sendtodb();'>Search GeoJSON</button></center>"; 
            
            // Marker Pin ‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏á‡∏Å‡∏•‡∏°
            var marker = L.marker([e.latlng.lat, e.latlng.lng], { icon: createColoredIcon('blue') }).addTo(map).bindPopup(ct).openPopup();
            marker_arr.push(marker);
        });

        map.on("dblclick", function (e) {
            // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Insert Data
            marker_arr.forEach(m => map.removeLayer(m)); marker_arr = [];
            var ct = "<center><h3>‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏´‡∏°‡πà</h3></center>";
            ct += "<label for='lat_insert'>Lat:</label> <input type='number' id='lat_insert' value='" + e.latlng.lat.toFixed(6) + "' readonly><br>";
            ct += "<label for='lng_insert'>Lng:</label> <input type='number' id='lng_insert' value='" + e.latlng.lng.toFixed(6) + "' readonly><br>";
            ct += "<label for='name_insert'>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà:</label> <input type='text' id='name_insert'><br>";
            
            // **[‡πÄ‡∏û‡∏¥‡πà‡∏°]** Input fields ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á
            ct += "<label for='province_insert'>‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î:</label> <input type='text' id='province_insert'><br>";
            ct += "<label for='elevation_m_insert'>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á (‡∏°.):</label> <input type='number' id='elevation_m_insert'><br><br>";
            
            ct += "<center><button onclick='inserttodb();'>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button></center>"; 
            var marker1 = L.marker([e.latlng.lat, e.latlng.lng], { icon: createColoredIcon('violet') }).addTo(map).bindPopup(ct).openPopup();
            marker_arr.push(marker1);
        });

        map.doubleClickZoom.disable(); 

        // ------------------------------------------------
        // [CORE CHANGE] ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• GeoJSON ‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å
        // ------------------------------------------------
        $(document).ready(function() {
             $.getJSON(GEOJSON_FILE_URL, function(data) {
                 hikingSpotsGeoJSON = data; 
                 initializeMapControls(); 
             })
             .fail(function(jqxhr, textStatus, error) {
                 const err = textStatus + ", " + error;
                 console.error("‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î GeoJSON ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: " + err);
                 alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå GeoJSON ‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏ü‡∏•‡πå: " + GEOJSON_FILE_URL);
             });
        });

</script> 
</body>
</html>