<!DOCTYPE html> 
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>üìä ‡∏Å‡∏£‡∏≤‡∏ü‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;500;700&display=swap" rel="stylesheet" />

  <style>
    /* ... (CSS styles remain unchanged) ... */
   body {
        margin: 0;
        font-family: 'Prompt', sans-serif;
        background: linear-gradient(135deg, #f9f7f1, #e8e3d9);
        padding: 30px 20px;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        min-height: 100vh;
        overflow-y: auto;
        color: #5a4a1a;
        box-sizing: border-box;
    }

    .chart-container {
        background: #fff;
        border-radius: 20px;
        box-shadow: 0 6px 25px rgba(101, 85, 42, 0.2);
        padding: 30px 50px;
        max-width: 600px;
        width: 100%;
        text-align: center;
    }

    h3 {
        margin-bottom: 25px;
        margin-top: 0;
        font-weight: 700;
        font-size: 2rem;
        color: #6b5832;
        z-index: 10;
        position: relative;
    }
  </style>
</head>

<body>
  <div class="chart-container"> <h3>üìä ‡∏Å‡∏£‡∏≤‡∏ü‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£</h3>
    
    <canvas id="pieChart"></canvas>
    
  </div>

  <script>
    let pieChart;

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô: ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• GeoJSON ‡∏à‡∏≤‡∏Å PHP
    async function fetchGeoJSON(keyword = '') {
        const encodedKeyword = encodeURIComponent(keyword);
        const url = `agi65.php?type=keyword&value=${encodedKeyword}`; 
        try {
            const response = await fetch(url);
            return await response.json(); 
        } catch (error) {
            console.error("Error fetching data for charts:", error);
            return { features: [] };
        }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á/‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏£‡∏≤‡∏ü‡∏ß‡∏á‡∏Å‡∏•‡∏° ‡πÇ‡∏î‡∏¢‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á
    async function updateCharts(keyword = '') {
        const liveGeojson = await fetchGeoJSON(keyword);
        const filtered = liveGeojson.features;

        // ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£
        const courseCounts = {};
        filtered.forEach(f => {
            const c = f.properties.curriculum || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏"; 
            courseCounts[c] = (courseCounts[c] || 0) + 1;
        });

        if (pieChart) pieChart.destroy();

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á Pie Chart ‡πÉ‡∏´‡∏°‡πà
        pieChart = new Chart(document.getElementById('pieChart'), {
            type: 'pie', 
            data: {
                labels: Object.keys(courseCounts),
                datasets: [{
                    data: Object.values(courseCounts),
                    backgroundColor: [
                        '#e57373', '#f06292', '#ba68c8', '#9575cd', '#64b5f6',
                        '#4db6ac', '#81c784', '#dce775', '#ffd54f', '#ff8a65'
                    ]
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'bottom', labels: { color: '#5a4a1a', font: { weight: '600', size: 14 } } },
                    tooltip: { enabled: true, backgroundColor: '#6b5832', titleFont: { weight: '700' }, bodyFont: { size: 14 } }
                }
            }
        });
    }

    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡∏ï‡∏≠‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
    updateCharts('');

    // ‡∏£‡∏±‡∏ö keyword ‡∏à‡∏≤‡∏Å iframe ‡∏≠‡∏∑‡πà‡∏ô
    window.addEventListener("message", (e) => {
        const keyword = e.data.keyword || ''; 
        updateCharts(keyword);
    });
  </script>
</body>
</html>